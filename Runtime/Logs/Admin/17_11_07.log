[ 2017-11-07T15:22:37+08:00 ] ::1 /admin.php/posts/edit/id/22.html
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000035s ]
INFO: [ app_init ] --END-- [ RunTime:0.000939s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000907s ]
INFO: [ app_begin ] --END-- [ RunTime:0.001018s ]
SQL: SHOW COLUMNS FROM `blog_powers` [ RunTime:0.0033s ]
SQL: SELECT * FROM `blog_powers`  [ RunTime:0.0031s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` = 0 ORDER BY sort asc  [ RunTime:0.0026s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` <> 0 AND `HideInMenu` = 0 ORDER BY sort asc  [ RunTime:0.0026s ]
SQL: SELECT `name`,`fid` FROM `blog_powers` WHERE `url` = 'posts/edit' LIMIT 1   [ RunTime:0.0037s ]
SQL: SELECT `name` FROM `blog_powers` WHERE `id` = 75 LIMIT 1   [ RunTime:0.0026s ]
SQL: SHOW COLUMNS FROM `blog_posts` [ RunTime:0.0047s ]
SQL: SELECT * FROM `blog_posts` WHERE `id` = 22 LIMIT 1   [ RunTime:0.0026s ]
SQL: SHOW COLUMNS FROM `blog_dicts` [ RunTime:0.0045s ]
SQL: SELECT * FROM `blog_dicts` WHERE `cateId` = 4  [ RunTime:0.0026s ]
SQL: SELECT * FROM `blog_dicts` WHERE `cateId` = 7  [ RunTime:0.0027s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000137s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000229s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013750s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013855s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000482s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000560s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.001055s ]
INFO: [ app_end ] --END-- [ RunTime:0.001196s ]

[ 2017-11-07T15:23:22+08:00 ] ::1 /admin.php/posts/edit/id/22.html
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000025s ]
INFO: [ app_init ] --END-- [ RunTime:0.000415s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000523s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000636s ]
SQL: SHOW COLUMNS FROM `blog_powers` [ RunTime:0.0074s ]
SQL: SELECT * FROM `blog_powers`  [ RunTime:0.0060s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` = 0 ORDER BY sort asc  [ RunTime:0.0060s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` <> 0 AND `HideInMenu` = 0 ORDER BY sort asc  [ RunTime:0.0063s ]
SQL: SELECT `name`,`fid` FROM `blog_powers` WHERE `url` = 'posts/edit' LIMIT 1   [ RunTime:0.0057s ]
SQL: SELECT `name` FROM `blog_powers` WHERE `id` = 75 LIMIT 1   [ RunTime:0.0061s ]
SQL: SHOW COLUMNS FROM `blog_posts` [ RunTime:0.0064s ]
SQL: UPDATE `blog_posts` SET `title`='抢红包秒杀理解与实现',`cate`='29',`tags`='|8|25|',`createtime`='1505282010',`content`='###简单流程

![示例图片](/Data/2017-11-07/5a0148dbad804.png &quot;示例图片&quot;)

###红包何时拆？

1. 发起者点击发送后，预先拆好红包

2. 由抢红包用户触发，抢一个计算一个金额

如果由用户来触发拆红包，当拆红包请求达到一个量级的时候，可能会对服务器造成比较大的压力，所以我们在发起者发送完红包后直接计算好红包分数及对应的金额，用户抢红包请求到达，直接赋值，无需计算

###发起红包时拆分，将红包拆分好入栈，简单递归下

    $count = 3; //3个红包

    $sum = 100; //100元

    $current = array();


    function do_split($sum , $cnt){
        global $current;
        if($cnt === 1){
            $current[] = $sum;
        }else{
            $ld = 0.01;
            $total = $sum / $ld;
            $max = round($total / $cnt);
            $min = 1;
            $currWhide = rand($min , 2 * $max);
            $current[] = $jqje = $currWhide * $ld;
            $syje = $sum - $jqje;
            do_split( $syje , $cnt - 1);
        }
        
    }


    do_split($sum , $count);

    var_dump($current);

    foreach ($current as $key =&gt; $value) {
        $redis-&gt;lpush(\'hongbao1\',$value);
    }

###用户抢红包

    $uid = $_GET[\'uid\'];
    $je = $redis-&gt;lpop(\'hongbao1\');
    if($je &gt; 0){
        echo \'恭喜\'.$uid.\'您抢到\'.$je.\'元\';
    }else{
        echo $uid.\'您的手也太慢了吧！\';
    }

项目地址：[github](https://github.com/juelite/qianghongbao &quot;抢红包&quot;)',`status`='1',`url`='qiang-hong-bao-miao-sha-li-jie-yu-shi-xian',`updatetime`='1510039402' WHERE `id` = 22 [ RunTime:0.0185s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000098s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000206s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.007529s ]
INFO: [ view_parse ] --END-- [ RunTime:0.007679s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000345s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000549s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000780s ]
INFO: [ app_end ] --END-- [ RunTime:0.001033s ]

[ 2017-11-07T15:23:23+08:00 ] ::1 /admin.php/posts/lists.html
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000034s ]
INFO: [ app_init ] --END-- [ RunTime:0.000663s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000576s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000694s ]
SQL: SHOW COLUMNS FROM `blog_powers` [ RunTime:0.0057s ]
SQL: SELECT * FROM `blog_powers`  [ RunTime:0.0063s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` = 0 ORDER BY sort asc  [ RunTime:0.0059s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` <> 0 AND `HideInMenu` = 0 ORDER BY sort asc  [ RunTime:0.0066s ]
SQL: SELECT `name`,`fid` FROM `blog_powers` WHERE `url` = 'posts/lists' LIMIT 1   [ RunTime:0.0052s ]
SQL: SELECT `name` FROM `blog_powers` WHERE `id` = 75 LIMIT 1   [ RunTime:0.0060s ]
SQL: SHOW COLUMNS FROM `blog_posts` [ RunTime:0.0066s ]
SQL: SELECT COUNT(*) AS tp_count FROM `blog_posts` WHERE `status` IN ('0','1') LIMIT 1   [ RunTime:0.0053s ]
SQL: SELECT * FROM `blog_posts` WHERE `status` IN ('0','1') ORDER BY createtime desc,id desc LIMIT 0,10   [ RunTime:0.0180s ]
SQL: SHOW COLUMNS FROM `blog_dicts` [ RunTime:0.0052s ]
SQL: SELECT * FROM `blog_dicts` WHERE `cateId` = 4  [ RunTime:0.0064s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000157s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000322s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.013308s ]
INFO: [ view_parse ] --END-- [ RunTime:0.013429s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000250s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000397s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000744s ]
INFO: [ app_end ] --END-- [ RunTime:0.000849s ]

[ 2017-11-07T15:23:41+08:00 ] ::1 /admin.php/posts/edit/id/22.html
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000021s ]
INFO: [ app_init ] --END-- [ RunTime:0.000355s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000438s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000537s ]
SQL: SHOW COLUMNS FROM `blog_powers` [ RunTime:0.0056s ]
SQL: SELECT * FROM `blog_powers`  [ RunTime:0.0059s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` = 0 ORDER BY sort asc  [ RunTime:0.0058s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` <> 0 AND `HideInMenu` = 0 ORDER BY sort asc  [ RunTime:0.0063s ]
SQL: SELECT `name`,`fid` FROM `blog_powers` WHERE `url` = 'posts/edit' LIMIT 1   [ RunTime:0.0051s ]
SQL: SELECT `name` FROM `blog_powers` WHERE `id` = 75 LIMIT 1   [ RunTime:0.0064s ]
SQL: SHOW COLUMNS FROM `blog_posts` [ RunTime:0.0055s ]
SQL: SELECT * FROM `blog_posts` WHERE `id` = 22 LIMIT 1   [ RunTime:0.0057s ]
SQL: SHOW COLUMNS FROM `blog_dicts` [ RunTime:0.0061s ]
SQL: SELECT * FROM `blog_dicts` WHERE `cateId` = 4  [ RunTime:0.0060s ]
SQL: SELECT * FROM `blog_dicts` WHERE `cateId` = 7  [ RunTime:0.0060s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000138s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000228s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.010006s ]
INFO: [ view_parse ] --END-- [ RunTime:0.010098s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000164s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000233s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000551s ]
INFO: [ app_end ] --END-- [ RunTime:0.000657s ]

[ 2017-11-07T15:23:45+08:00 ] ::1 /admin.php/posts/edit/id/22.html
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000022s ]
INFO: [ app_init ] --END-- [ RunTime:0.000367s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000603s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000720s ]
SQL: SHOW COLUMNS FROM `blog_powers` [ RunTime:0.0031s ]
SQL: SELECT * FROM `blog_powers`  [ RunTime:0.0042s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` = 0 ORDER BY sort asc  [ RunTime:0.0038s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` <> 0 AND `HideInMenu` = 0 ORDER BY sort asc  [ RunTime:0.0043s ]
SQL: SELECT `name`,`fid` FROM `blog_powers` WHERE `url` = 'posts/edit' LIMIT 1   [ RunTime:0.0026s ]
SQL: SELECT `name` FROM `blog_powers` WHERE `id` = 75 LIMIT 1   [ RunTime:0.0025s ]
SQL: SHOW COLUMNS FROM `blog_posts` [ RunTime:0.0032s ]
SQL: UPDATE `blog_posts` SET `title`='抢红包秒杀理解与实现',`cate`='29',`tags`='|8|25|',`createtime`='1505282010',`content`='
###简单流程

![示例图片](/Data/2017-11-07/5a0148dbad804.png &quot;示例图片&quot;)

###红包何时拆？

1. 发起者点击发送后，预先拆好红包

2. 由抢红包用户触发，抢一个计算一个金额

如果由用户来触发拆红包，当拆红包请求达到一个量级的时候，可能会对服务器造成比较大的压力，所以我们在发起者发送完红包后直接计算好红包分数及对应的金额，用户抢红包请求到达，直接赋值，无需计算

###发起红包时拆分，将红包拆分好入栈，简单递归下

    $count = 3; //3个红包

    $sum = 100; //100元

    $current = array();


    function do_split($sum , $cnt){
        global $current;
        if($cnt === 1){
            $current[] = $sum;
        }else{
            $ld = 0.01;
            $total = $sum / $ld;
            $max = round($total / $cnt);
            $min = 1;
            $currWhide = rand($min , 2 * $max);
            $current[] = $jqje = $currWhide * $ld;
            $syje = $sum - $jqje;
            do_split( $syje , $cnt - 1);
        }
        
    }


    do_split($sum , $count);

    var_dump($current);

    foreach ($current as $key =&gt; $value) {
        $redis-&gt;lpush(\'hongbao1\',$value);
    }

###用户抢红包

    $uid = $_GET[\'uid\'];
    $je = $redis-&gt;lpop(\'hongbao1\');
    if($je &gt; 0){
        echo \'恭喜\'.$uid.\'您抢到\'.$je.\'元\';
    }else{
        echo $uid.\'您的手也太慢了吧！\';
    }

项目地址：[github](https://github.com/juelite/qianghongbao &quot;抢红包&quot;)',`status`='1',`url`='qiang-hong-bao-miao-sha-li-jie-yu-shi-xian',`updatetime`='1510039425' WHERE `id` = 22 [ RunTime:0.0067s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000075s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000162s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.005302s ]
INFO: [ view_parse ] --END-- [ RunTime:0.005381s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000168s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000236s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000472s ]
INFO: [ app_end ] --END-- [ RunTime:0.000545s ]

[ 2017-11-07T15:23:47+08:00 ] ::1 /admin.php/posts/lists.html
INFO: [ app_init ] --START--
INFO: Run Behavior\BuildLiteBehavior [ RunTime:0.000020s ]
INFO: [ app_init ] --END-- [ RunTime:0.000350s ]
INFO: [ app_begin ] --START--
INFO: Run Behavior\ReadHtmlCacheBehavior [ RunTime:0.000408s ]
INFO: [ app_begin ] --END-- [ RunTime:0.000485s ]
SQL: SHOW COLUMNS FROM `blog_powers` [ RunTime:0.0086s ]
SQL: SELECT * FROM `blog_powers`  [ RunTime:0.0082s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` = 0 ORDER BY sort asc  [ RunTime:0.0089s ]
SQL: SELECT * FROM `blog_powers` WHERE `fid` <> 0 AND `HideInMenu` = 0 ORDER BY sort asc  [ RunTime:0.0100s ]
SQL: SELECT `name`,`fid` FROM `blog_powers` WHERE `url` = 'posts/lists' LIMIT 1   [ RunTime:0.0077s ]
SQL: SELECT `name` FROM `blog_powers` WHERE `id` = 75 LIMIT 1   [ RunTime:0.0077s ]
SQL: SHOW COLUMNS FROM `blog_posts` [ RunTime:0.0101s ]
SQL: SELECT COUNT(*) AS tp_count FROM `blog_posts` WHERE `status` IN ('0','1') LIMIT 1   [ RunTime:0.0086s ]
SQL: SELECT * FROM `blog_posts` WHERE `status` IN ('0','1') ORDER BY createtime desc,id desc LIMIT 0,10   [ RunTime:0.0292s ]
SQL: SHOW COLUMNS FROM `blog_dicts` [ RunTime:0.0083s ]
SQL: SELECT * FROM `blog_dicts` WHERE `cateId` = 4  [ RunTime:0.0079s ]
INFO: [ view_parse ] --START--
INFO: [ template_filter ] --START--
INFO: Run Behavior\ContentReplaceBehavior [ RunTime:0.000166s ]
INFO: [ template_filter ] --END-- [ RunTime:0.000294s ]
INFO: Run Behavior\ParseTemplateBehavior [ RunTime:0.011192s ]
INFO: [ view_parse ] --END-- [ RunTime:0.011295s ]
INFO: [ view_filter ] --START--
INFO: Run Behavior\WriteHtmlCacheBehavior [ RunTime:0.000177s ]
INFO: [ view_filter ] --END-- [ RunTime:0.000247s ]
INFO: [ app_end ] --START--
INFO: Run Behavior\ShowPageTraceBehavior [ RunTime:0.000579s ]
INFO: [ app_end ] --END-- [ RunTime:0.000672s ]

